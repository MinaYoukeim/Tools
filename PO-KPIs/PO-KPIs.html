<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Owner KPI Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;           /* slate-900 */
      --panel: #111827;        /* gray-900 */
      --muted: #475569;        /* slate-600 */
      --text: #e2e8f0;         /* slate-200 */
      --brand: #38bdf8;        /* sky-400 */
      --accent: #22d3ee;       /* cyan-400 */
      --danger: #ef4444;       /* red-500 */
      --ok: #22c55e;           /* green-500 */
      --card: #0b1220;         /* custom */
      --border: #1f2937;       /* gray-800 */
      --paper: #ffffff;        /* print background */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 70% -10%, rgba(56,189,248,0.08), transparent 60%), var(--bg);
      color: var(--text);
    }
    header {
      padding: 24px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(15,23,42,0.85), rgba(15,23,42,0.6));
      z-index: 10;
    }
    .title { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 20px; }
    .title .badge { font-weight: 600; color: var(--bg); background: linear-gradient(135deg, var(--brand), var(--accent)); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    main { padding: 24px; max-width: 1200px; margin: 0 auto; }

    .grid { display: grid; gap: 16px; }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .grid.cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    @media (max-width: 1000px) { .grid.cols-4{grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 800px)  { .grid.cols-3,.grid.cols-2,.grid.cols-4{grid-template-columns: 1fr;} header{position: static;} }

    .card {
      background: linear-gradient(180deg, rgba(17,24,39,0.9), rgba(2,6,23,0.7));
      border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 8px 30px rgba(2,6,23,0.6);
    }
    .card h3 { margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #94a3b8; letter-spacing: 0.02em; }
    .stat { font-size: 28px; font-weight: 700; }

    .inputs { display: grid; grid-template-columns: 1.2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; }
    .inputs.small { grid-template-columns: 1fr 1fr auto auto; }
    .inputs label { font-size: 12px; color: #9aa6b2; display:block; margin-bottom: 6px; }
    .inputs input, .inputs select { width: 100%; padding: 10px 12px; background: #0b1220; border: 1px solid var(--border); border-radius: 12px; color: var(--text); outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
    .inputs input:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(56,189,248,0.2); }
    .btn { appearance: none; border: none; border-radius: 12px; padding: 10px 14px; font-weight: 600; color: var(--bg); background: linear-gradient(135deg, var(--brand), var(--accent)); cursor: pointer; box-shadow: 0 6px 16px rgba(34,211,238,0.25); }
    .btn.secondary { background: #0b1220; color: var(--text); border: 1px solid var(--border); box-shadow: none; }
    .btn.danger { background: var(--danger); color: white; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); font-size: 14px; }
    th { text-align: left; color: #94a3b8; font-weight: 600; }
    tbody tr:hover { background: rgba(56,189,248,0.05); }

    .kpi { display:flex; gap:12px; align-items:center; }
    .pill { padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); font-size: 12px; color: #cbd5e1; }
    .toolbar { display:flex; gap:8px; flex-wrap: wrap; }

    .charts { display: grid; gap: 16px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 900px) { .charts { grid-template-columns: 1fr; } }
    .chart-card canvas { width: 100% !important; height: 260px !important; display: block; background: #0a0f1e; border: 1px solid var(--border); border-radius: 16px; padding: 8px; }

    footer { color: #94a3b8; font-size: 12px; text-align: center; padding: 32px 16px; }

    /* Hide rate column when configured */
    body.hide-rate th.rate, body.hide-rate td.rate { display: none; }
    body.print-mode .no-print { display: none !important; }

    /* Print styles */
    @media print {
      body { background: var(--paper) !important; color: #0f172a; }
      header { position: static; background: var(--paper); color: #0f172a; border-bottom: 1px solid #e5e7eb; }
      .badge { display: none; }
      .card { background: white; box-shadow: none; border-color: #e5e7eb; }
      .no-print { display: none !important; }
      .chart-card canvas { height: 220px !important; background: white; border-color: #e5e7eb; }
      .page-break { page-break-before: always; }
      body.hide-rate th.rate, body.hide-rate td.rate { display: none !important; }
      tbody tr:hover { background: none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M4 6a2 2 0 012-2h7a1 1 0 010 2H6v12h12v-7a1 1 0 112 0v7a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" fill="currentColor" opacity="0.6"/><path d="M10 10a1 1 0 011-1h3.586l-5.293 5.293a1 1 0 101.414 1.414L16 10.414V14a1 1 0 102 0V8a1 1 0 00-1-1h-6a1 1 0 00-1 1z" fill="currentColor"/></svg>
      <span>Product Owner KPI Dashboard</span>
      <span class="badge">Single-file HTML</span>
    </div>
  </header>

  <main>
    <!-- Confidential global settings -->
    <section class="card no-print" aria-labelledby="settings">
      <h3 id="settings">Confidential Settings</h3>
      <div class="inputs small">
        <div>
          <label for="globalRate">Global Hourly Rate (hidden from report)</label>
          <input id="globalRate" type="number" inputmode="decimal" placeholder="e.g. 85" min="0" step="0.01"/>
        </div>
        <div>
          <label for="hideRate">Visibility</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="hideRate" type="checkbox" checked /> <span>Hide hourly rate column (recommended)</span>
          </div>
        </div>
        <button class="btn" id="saveSettingsBtn">Save Settings</button>
        <button class="btn secondary" id="printBtn" title="Print without confidential info">Print Report</button>
      </div>
      <div class="toolbar" style="margin-top:8px;">
        <span class="pill">Note: The hourly rate is stored locally and will not appear in the dataset or printed report.</span>
      </div>
    </section>

    <section class="card" aria-labelledby="data-entry">
      <h3 id="data-entry">Add / Update Monthly Data</h3>
      <div class="inputs">
        <div>
          <label for="month">Month</label>
          <input id="month" type="month" />
        </div>
        <div>
          <label for="storyPoints">Story Points</label>
          <input id="storyPoints" type="number" inputmode="decimal" placeholder="e.g. 120" min="0" step="0.01"/>
        </div>
        <div>
          <label for="hours">Hours</label>
          <input id="hours" type="number" inputmode="decimal" placeholder="e.g. 640" min="0" step="0.01"/>
        </div>
        <div>
          <label for="rate">Hourly Rate (optional; overrides global)</label>
          <input id="rate" type="number" inputmode="decimal" placeholder="leave empty to use global" min="0" step="0.01"/>
        </div>
        <button class="btn" id="addBtn">Save Month</button>
      </div>
      <div style="margin-top:12px" class="toolbar no-print">
        <button class="btn secondary" id="exportBtn" title="Download your data as JSON">Export JSON</button>
        <label class="btn secondary" for="importFile" title="Import data from JSON">Import JSON<input id="importFile" type="file" accept="application/json" hidden></label>
        <button class="btn secondary" id="clearBtn" title="Remove all months">Clear All</button>
        <span class="pill" id="currencyInfo">Currency: €</span>
      </div>
    </section>

    <section class="grid cols-3" style="margin-top:16px">
      <div class="card">
        <h3>Total Story Points</h3>
        <div class="stat" id="totalSP">0</div>
      </div>
      <div class="card">
        <h3>Total Hours</h3>
        <div class="stat" id="totalHours">0</div>
      </div>
      <div class="card">
        <h3>Total Cost</h3>
        <div class="stat" id="totalCost">€0</div>
      </div>
      <div class="card">
        <h3>Average Story Points / Month</h3>
        <div class="stat" id="avgSP">0</div>
      </div>
      <div class="card">
        <h3>Average Hours / Month</h3>
        <div class="stat" id="avgHours">0</div>
      </div>
      <div class="card">
        <h3>Average Cost / Month</h3>
        <div class="stat" id="avgCost">€0</div>
      </div>
    </section>

    <section class="card" style="margin-top:16px" aria-labelledby="dataset">
      <h3 id="dataset">Dataset</h3>
      <div style="overflow:auto">
        <table id="dataTable" aria-describedby="dataset">
          <thead>
            <tr>
              <th>Month</th>
              <th>Story Points</th>
              <th>Hours</th>
              <th class="rate">Hourly Rate</th>
              <th>Cost</th>
              <th>Cost/SP</th>
              <th>Hours/SP</th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section style="margin-top:16px">
      <div class="charts">
        <div class="card chart-card"><h3>Story Points by Month</h3><canvas id="spChart"></canvas></div>
        <div class="card chart-card"><h3>Hours by Month</h3><canvas id="hoursChart"></canvas></div>
        <div class="card chart-card"><h3>Cost by Month</h3><canvas id="costChart"></canvas></div>
        <div class="card chart-card"><h3>Cost per Story Point</h3><canvas id="cpspChart"></canvas></div>
        <div class="card chart-card"><h3>Hours per Story Point</h3><canvas id="hpspChart"></canvas></div>
      </div>
    </section>
  </main>

  <footer class="no-print">
    Built for Product Owners • Data is stored locally in your browser (localStorage). • Currency is displayed as Euro by default.
  </footer>

  <script>
    // --- Persistence Layer ---
    const STORAGE_KEY = 'po_kpi_data_v1';
    const SETTINGS_KEY = 'po_kpi_settings_v1';
    function loadData(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; } }
    function saveData(rows){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }
    function loadSettings(){
      try { return Object.assign({ globalRate: 0, hideRate: true }, JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}); } catch { return { globalRate: 0, hideRate: true }; }
    }
    function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }

    // --- Utilities ---
    const fmt = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
    const fmtMoney = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'EUR' });
    function monthLabel(ym){ const [y,m] = ym.split('-').map(Number); const d = new Date(y, m-1, 1); return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short' }); }
    function sortByMonthAsc(a,b){ return a.month.localeCompare(b.month); }

    // --- State ---
    let data = loadData(); // [{month:"2025-01", sp: 120, hours: 640, rate: 85}]
    let settings = loadSettings();

    // --- Elements ---
    const el = id => document.getElementById(id);
    const monthEl = el('month');
    const spEl = el('storyPoints');
    const hrsEl = el('hours');
    const rateEl = el('rate');
    const globalRateEl = el('globalRate');
    const hideRateEl = el('hideRate');

    // Prefill month with current & settings
    (function init(){
      const now = new Date();
      const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      monthEl.value = ym;
      globalRateEl.value = settings.globalRate || '';
      hideRateEl.checked = !!settings.hideRate;
      applyVisibility();
    })();

    function applyVisibility(){
      document.body.classList.toggle('hide-rate', !!settings.hideRate);
    }

    // --- Settings handlers ---
    el('saveSettingsBtn').addEventListener('click', () => {
      const gr = Number(globalRateEl.value || 0);
      settings.globalRate = gr; settings.hideRate = !!hideRateEl.checked;
      saveSettings(settings); applyVisibility(); render();
    });

    el('printBtn').addEventListener('click', () => {
      // Ensure hide-rate is respected while printing
      settings.hideRate = true; saveSettings(settings); applyVisibility();
      window.print();
    });

    // --- Add/Update row ---
    el('addBtn').addEventListener('click', () => {
      const month = monthEl.value;
      const sp = Number(spEl.value || 0);
      const hours = Number(hrsEl.value || 0);
      const rate = rateEl.value === '' ? 0 : Number(rateEl.value || 0); // 0 = use global
      if(!month){ alert('Please select a month.'); return; }
      const idx = data.findIndex(r => r.month === month);
      const row = { month, sp, hours, rate };
      if(idx >= 0) data[idx] = row; else data.push(row);
      data.sort(sortByMonthAsc);
      saveData(data);
      clearInputs();
      render();
    });

    function clearInputs(){ spEl.value=''; hrsEl.value=''; rateEl.value=''; }

    // --- Import/Export/Clear ---
    el('exportBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'product-owner-kpi-data.json'; a.click();
      URL.revokeObjectURL(url);
    });

    el('importFile').addEventListener('change', (e) => {
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if(!Array.isArray(parsed)) throw new Error('Invalid format');
          data = parsed.filter(r => r && r.month && typeof r.month === 'string')
                       .map(r => ({ month: r.month, sp: Number(r.sp||0), hours: Number(r.hours||0), rate: Number(r.rate||0) }))
                       .sort(sortByMonthAsc);
          saveData(data); render();
        } catch(err){ alert('Could not import file: ' + err.message); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    el('clearBtn').addEventListener('click', () => {
      if(confirm('This will remove all months. Continue?')){ data = []; saveData(data); render(); }
    });

    // --- Table rendering ---
    const tbody = document.querySelector('#dataTable tbody');
    function effectiveRateFor(row){ return (row.rate && row.rate > 0) ? row.rate : (settings.globalRate || 0); }

    function renderTable(){
      tbody.innerHTML = '';
      data.forEach((r) => {
        const effRate = effectiveRateFor(r);
        const cost = r.hours * effRate;
        const cpsp = r.sp > 0 ? cost / r.sp : null;
        const hpsp = r.sp > 0 ? r.hours / r.sp : null;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${monthLabel(r.month)}</td>
          <td>${fmt.format(r.sp)}</td>
          <td>${fmt.format(r.hours)}</td>
          <td class="rate">${effRate ? fmtMoney.format(effRate) : '— (global not set)'}</td>
          <td>${fmtMoney.format(cost)}</td>
          <td>${cpsp!=null ? fmtMoney.format(cpsp) : '—'}</td>
          <td>${hpsp!=null ? fmt.format(hpsp) : '—'}</td>
          <td class="no-print">
            <div class="toolbar">
              <button class="btn secondary" data-edit="${r.month}">Edit</button>
              <button class="btn danger" data-del="${r.month}">Delete</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button[data-edit]').forEach(btn => btn.addEventListener('click', () => {
        const m = btn.getAttribute('data-edit');
        const row = data.find(x => x.month === m);
        if(row){ monthEl.value = row.month; spEl.value = row.sp; hrsEl.value = row.hours; rateEl.value = row.rate || ''; window.scrollTo({ top: 0, behavior: 'smooth' }); }
      }));
      tbody.querySelectorAll('button[data-del]').forEach(btn => btn.addEventListener('click', () => {
        const m = btn.getAttribute('data-del');
        if(confirm('Delete ' + monthLabel(m) + '?')){ data = data.filter(x => x.month !== m); saveData(data); render(); }
      }));
    }

    // --- KPIs ---
    function calcTotals(){
      const totals = data.reduce((acc, r) => {
        const effRate = effectiveRateFor(r);
        acc.sp += r.sp; acc.hours += r.hours; acc.cost += r.hours * effRate; return acc;
      }, { sp: 0, hours: 0, cost: 0 });
      const n = data.length || 1;
      const avg = { sp: totals.sp / n, hours: totals.hours / n, cost: totals.cost / n };
      return { totals, avg };
    }
    function renderKPIs(){
      const { totals, avg } = calcTotals();
      el('totalSP').textContent = fmt.format(totals.sp);
      el('totalHours').textContent = fmt.format(totals.hours);
      el('totalCost').textContent = fmtMoney.format(totals.cost);
      el('avgSP').textContent = fmt.format(avg.sp);
      el('avgHours').textContent = fmt.format(avg.hours);
      el('avgCost').textContent = fmtMoney.format(avg.cost);
    }

    // --- Charts ---
    const charts = { };
    function destroyCharts(){ Object.values(charts).forEach(ch => ch?.destroy()); }

    function buildChart(canvasId, labels, datasetLabel, values){
      const ctx = document.getElementById(canvasId);
      return new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: datasetLabel, data: values, tension: 0.25, fill: false, pointRadius: 3 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { grid: { color: 'rgba(148,163,184,0.1)' }, ticks: { color: '#cbd5e1' } },
            y: { grid: { color: 'rgba(148,163,184,0.1)' }, ticks: { color: '#cbd5e1', callback: v => typeof v === 'number' ? v.toLocaleString() : v } }
          },
          plugins: { legend: { labels: { color: '#cbd5e1' } } }
        }
      });
    }

    function renderCharts(){
      destroyCharts();
      const labels = data.map(r => monthLabel(r.month));
      const sp = data.map(r => r.sp);
      const hours = data.map(r => r.hours);
      const cost = data.map(r => r.hours * effectiveRateFor(r));
      const cpsp = data.map(r => r.sp > 0 ? (r.hours * effectiveRateFor(r)) / r.sp : null);
      const hpsp = data.map(r => r.sp > 0 ? r.hours / r.sp : null);

      charts.sp = buildChart('spChart', labels, 'Story Points', sp);
      charts.hours = buildChart('hoursChart', labels, 'Hours', hours);
      charts.cost = buildChart('costChart', labels, 'Cost', cost);
      charts.cpsp = buildChart('cpspChart', labels, 'Cost / Story Point', cpsp);
      charts.hpsp = buildChart('hpspChart', labels, 'Hours / Story Point', hpsp);
    }

    function render(){ renderTable(); renderKPIs(); renderCharts(); }

    // --- First render ---
    render();
  </script>
</body>
</html>